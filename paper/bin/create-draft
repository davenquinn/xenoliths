#!/usr/bin/env zsh
dir=$PROJECT_DIR/versioned/paper
cd $dir

# collect includes
bin/collect-figures

build_dir='build'

body="$build_dir/draft_body.tex"
texfile="$build_dir/draft.tex"

name="Crystal-Knob-xenoliths"
auxfile="$build_dir/$name.aux"

function run-latex {
  latexmk -xelatex -quiet -f -jobname=$name -output-directory=$build_dir $1
}

mkdir -p build

source bin/defs.zsh

echo "Converting markdown to latex"

rm -f $body build/abstract.tex build/figure-list.tex
# Process body text
# Correct for pandoc-crossref annoyingness
cat text/chapters/*.md \
| text-pipeline \
| sed -r 's/^\\section\{(Introduction)\}/\\invisiblesection\{\1\}/g' \
> $body
# Process abstract
cat text/abstract.md \
| text-pipeline \
> build/abstract.tex

cp text/title-block.tex build

cat text/key-points.md | text-pipeline > build/key-points.tex

captions=build/figure-captions.tex

cat text/figure-captions.md \
| text-pipeline \
> $captions

cat text/modeling-supplement.md \
| text-pipeline \
> build/modeling-supplement.tex

# Making figure list
figurator list \
  text/includes.yaml \
  --captions $captions \
  --collect-dir collected \
| sed -r 's/^\\section\{(.+)\}/\\invisiblesection\{\1\}/g' \
> build/figure-list.tex

cp source/draft.tex $texfile

echo "Filtering bibliography"

# Filter bibliography
LIBRARY="/Users/Daven/Resources/Papers/library.bib"
bib-filter --clean --aux $auxfile $LIBRARY $bibfile
# rebuild citations
bibtex $auxfile

echo "Running latex"

run-latex $texfile

outfile="output/$name.pdf"

mv "build/$name.pdf" "$outfile"

tag --set paper-draft $outfile

/usr/local/bin/gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/default \
    -dNOPAUSE -dQUIET -dBATCH -dDetectDuplicateImages \
    -dRENDERTTNOTDEF=true \
    -dCompressFonts=true -r150 -sOutputFile="output/${name}-compressed.pdf" $outfile
