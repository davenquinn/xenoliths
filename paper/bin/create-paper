#!/usr/bin/env zsh
dir=$PROJECT_DIR/versioned/paper
cd $dir

# collect includes
bin/collect-figures

build_dir='build'

agubuild="$build_dir/agu-format"

body="$agubuild/draft_body.tex"

name="Crystal-Knob-xenoliths-AGUFormat"
auxfile="$build_dir/$name.aux"
texfile="$agubuild/$name.tex"

mkdir -p $agubuild

function run-latex {
  latexmk -xelatex -quiet -f -jobname=$name -output-directory=$agubuild $1
}

source bin/defs.zsh

echo "Converting markdown to latex"

captions=build/figure-captions.tex
cat text/figure-captions.md \
| text-pipeline \
> $captions

# Process body text
# Correct for pandoc-crossref annoyingness
cat text/chapters/*.md \
| sed -r 's/<!--\[\[\[(.+)\]\]\]-->/\\inlinefigure\{\1\}/g' \
| text-pipeline \
| figurator inline \
  text/includes.yaml \
  --captions $captions \
  --collect-dir collected \
| sed -r 's/^\\section\*\{Acknowledgements\}/\\acknowledgments/g' \
> $body
# Process abstract
cat text/abstract.md \
| text-pipeline \
> "$agubuild/abstract.tex"

cat text/key-points.md \
| text-pipeline \
| sed -r 's/itemize/keypoints/g' \
| sed -r 's/^\\tightlist//g' \
> $agubuild/key-points.tex

st=source/agu-template
cp $st/agufull08.bst \
   $st/agujournal.cls $agubuild

cat $st/preamble.tex \
    $agubuild/key-points.tex \
> $texfile

echo '\\begin{abstract}' >> $texfile
cat $agubuild/abstract.tex >> $texfile
echo '\\end{abstract}\n' >> $texfile
cat $body $build_dir/draft.bbl >> $texfile
echo '\\end{document}\n' >> $texfile

echo "Running latex"

run-latex $texfile

outfile="output/$name.pdf"

mv "$agubuild/$name.pdf" "$outfile"

tag --set paper-draft $outfile

