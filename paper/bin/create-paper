#!/usr/bin/env zsh
dir=$PROJECT_DIR/versioned/paper
cd $dir

# Collect figures
bin/collect-figures

body='build/body.tex'

mkdir -p build
# Process body text
cat text/chapters/*.md \
| figurator inline text/includes.yaml \
  --captions text/figure-captions.md \
  --collect-dir collected \
  --natbib \
| paper markdown-to-latex > $body
# Process abstract
cat text/abstract.md \
| paper markdown-to-latex \
> build/abstract.tex

auxfile=build/main.aux
# build citations
bibtex $auxfile
# Filter bibliography
LIBRARY=/Users/Daven/Resources/Papers/bibtex/library.bib
bib-filter --clean --aux $auxfile $LIBRARY
# rebuild citations
bibtex $auxfile

xelatex \
  -interaction=nonstopmode \
  -output-directory build "source/main.tex"

mv build/main.pdf output/Quinn-2016-xenoliths.pdf
